// SPDX-FileCopyrightText: 2025 Tillitis AB <tillitis.se>
// SPDX-License-Identifier: BSD-2-Clause

// clang-format off
#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <stdint.h>
#include <cmocka.h> // cmocka need to be included last
// clang-format on

#include <string.h>
#include <tkey/syscall.h> // cmocka need to be included last
			  //
#include "../../verifier/verify.h"
#include "../platform/fakesys.h"

// Private key used to sign:
//   000102030405060708090a0b0c0d0e0f
//   000102030405060708090a0b0c0d0e0f
//   9b62773323ef41a11834824194e55164
//   d325eb9cdcc10ddda7d10ade4fbd8f6d
static const uint8_t SIGNATURE[64] = {
    0x07, 0x9f, 0x49, 0x00, 0xf0, 0x93, 0xe9, 0xac, 0xed, 0x94, 0x64,
    0x62, 0x8e, 0xb7, 0x95, 0x45, 0x85, 0xb0, 0x27, 0x21, 0x5b, 0x0b,
    0x7f, 0xbf, 0x1d, 0xd7, 0x7f, 0x3b, 0xae, 0x43, 0x1e, 0x76, 0x01,
    0xad, 0xb1, 0xe5, 0x4d, 0xea, 0x85, 0x5a, 0xd6, 0xb2, 0xf8, 0x73,
    0x28, 0x38, 0xe6, 0xc4, 0x2f, 0x43, 0x94, 0x81, 0x4b, 0xd6, 0x6c,
    0xb4, 0x82, 0x85, 0x27, 0xf9, 0x2b, 0x2a, 0xbc, 0x0b,
};
static const uint8_t INVALID_SIGNATURE[64] = {
    0x00, 0x9f, 0x49, 0x00, 0xf0, 0x93, 0xe9, 0xac, 0xed, 0x94, 0x64,
    0x62, 0x8e, 0xb7, 0x95, 0x45, 0x85, 0xb0, 0x27, 0x21, 0x5b, 0x0b,
    0x7f, 0xbf, 0x1d, 0xd7, 0x7f, 0x3b, 0xae, 0x43, 0x1e, 0x76, 0x01,
    0xad, 0xb1, 0xe5, 0x4d, 0xea, 0x85, 0x5a, 0xd6, 0xb2, 0xf8, 0x73,
    0x28, 0x38, 0xe6, 0xc4, 0x2f, 0x43, 0x94, 0x81, 0x4b, 0xd6, 0x6c,
    0xb4, 0x82, 0x85, 0x27, 0xf9, 0x2b, 0x2a, 0xbc, 0x0f,
};
static const uint8_t PUBKEY[32] = {
    0x9b, 0x62, 0x77, 0x33, 0x23, 0xef, 0x41, 0xa1, 0x18, 0x34, 0x82,
    0x41, 0x94, 0xe5, 0x51, 0x64, 0xd3, 0x25, 0xeb, 0x9c, 0xdc, 0xc1,
    0x0d, 0xdd, 0xa7, 0xd1, 0x0a, 0xde, 0x4f, 0xbd, 0x8f, 0x6d,
};
static const uint8_t DIGEST[32] = {
    0x95, 0x3f, 0xc8, 0x8f, 0xc7, 0x61, 0x20, 0x06, 0x04, 0x63, 0x22,
    0xc6, 0xa1, 0x99, 0xb9, 0x59, 0xd3, 0xb4, 0xb2, 0xea, 0xdf, 0x71,
    0x1f, 0x71, 0xb2, 0xf8, 0x10, 0x0b, 0xd8, 0x78, 0x9e, 0xc2,
};

int __wrap_sys_reset(struct reset *rst, size_t len)
{
	check_expected(rst);
	check_expected(len);

	return 0;
}

static void test_should_boot_verified_flash_app_1(void **state)
{
	uint8_t signature[64];
	uint8_t pubkey[32];
	uint8_t digest[32];

	memcpy(signature, SIGNATURE, sizeof(signature));
	memcpy(pubkey, PUBKEY, sizeof(pubkey));
	memcpy(digest, DIGEST, sizeof(digest));

	fakesys_set_digsig(digest, signature);

	struct reset expected_reset = {0};
	expected_reset.type = START_FLASH1_VER;
	memcpy(expected_reset.app_digest, DIGEST,
	       sizeof(expected_reset.app_digest));
	memset(expected_reset.next_app_data, 0,
	       sizeof(expected_reset.next_app_data));

	expect_value(__wrap_sys_reset, len, 0);
	expect_memory(__wrap_sys_reset, rst, &expected_reset,
		      sizeof(expected_reset));

	reset_if_verified(pubkey, START_FLASH1_VER, digest, signature);
}

static void test_should_not_boot_non_verified_flash_app_1(void **state)
{
	uint8_t signature[64];
	uint8_t pubkey[32];
	uint8_t digest[32];

	memcpy(signature, INVALID_SIGNATURE, sizeof(signature));
	memcpy(pubkey, PUBKEY, sizeof(pubkey));
	memcpy(digest, DIGEST, sizeof(digest));

	fakesys_set_digsig(digest, signature);

	// expect_function_calls(__wrap_sys_reset, 0); // Unsupported by cmocka

	int ret =
	    reset_if_verified(pubkey, START_FLASH1_VER, digest, signature);

	assert_int_equal(ret, -1);
}

int main(void)
{
	const struct CMUnitTest tests[] = {
	    cmocka_unit_test(test_should_boot_verified_flash_app_1),
	    cmocka_unit_test(test_should_not_boot_non_verified_flash_app_1),
	};

	return cmocka_run_group_tests(tests, NULL, NULL);
}
